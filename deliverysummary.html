<!DOCTYPE html>
<html>
<head>
  <title>Delivery Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
  table, th, td {
    font-size: 12px; /* üëà Add this to set font size */
  }    
    .table-container {
    overflow-x: auto;
    width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f4f4f4;
    }

    img.thumbnail {
      width: 50px;
      cursor: pointer;
      border-radius: 2px;
    }

    .controls {
      margin-top: 1rem;
    }

    .controls button {
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .current-date-label {
      font-weight: bold;
    }
th[onclick] {
  cursor: pointer;
}    
  </style>
</head>
<body>
  <h2>Delivery Summary</h2>
<a href="pickuprequestsummary.html"> Requests Summary </a> | <a href="pickuprequest.html"> Request Forms </a> | <a href="pickup.html"> Pickup </a>  | <a href="delivery.html"> Delivery </a> | <a href="deliverysummary.html"> DVS </a> <br>
  <div class="controls">
    <button onclick="changeDay(-1)">‚¨ÖÔ∏è Previous Day</button>
    <span class="current-date-label" id="currentDateLabel"></span>
    <button onclick="changeDay(1)">Next Day ‚û°Ô∏è</button>
    <button onclick="showAll()">Show All</button>
  </div>
<div class="table-container">
  <table id="deliveryTable">
<thead>
  <tr>
    <th onclick="sortTable('timestamp')">Timestamp ‚ñ≤‚ñº</th>
    <th onclick="sortTable('JOR')">JOR ‚ñ≤‚ñº</th>
    <th onclick="sortTable('DeliveryStaff')">Delivery Staff ‚ñ≤‚ñº</th>
    <th onclick="sortTable('Comments')">Comments ‚ñ≤‚ñº</th>
    <th onclick="sortTable('DeliveryPayMethod')">Payment Method ‚ñ≤‚ñº</th>
    <th onclick="sortTable('PaymentType')">Payment Type ‚ñ≤‚ñº</th>
    <th>Media 1</th>
    <th>Media 2</th>
    <th>Media 3</th>
  </tr>
</thead>

    <tbody></tbody>
  </table>


</div>
  <script>
    const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyBDFVFZz1LVT5pefiCSx4AJC_jRekKyyTTlj5fghUW8hehEhZCKqLUy1w094DxfkeBbw/exec";
    let allData = [];
    let currentDate = new Date(); // Today by default
    let currentSort = { column: null, asc: true };
    fetch(SHEET_WEBAPP_URL)
      .then(res => res.json())
      .then(data => {
        if (!data || !data.length) return;

        // Sort by timestamp (Column D)
        allData = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        displayDataForDate(currentDate);
      });

    function displayDataForDate(date) {
      const tbody = document.querySelector("#deliveryTable tbody");
      tbody.innerHTML = "";

      const dayStart = new Date(date);
      dayStart.setHours(0, 0, 0, 0);

      const dayEnd = new Date(date);
      dayEnd.setHours(23, 59, 59, 999);

      const filtered = allData.filter(row => {
        const ts = new Date(row.timestamp);
        return ts >= dayStart && ts <= dayEnd;
      });

      document.getElementById("currentDateLabel").textContent =
        `Showing for: ${dayStart.toLocaleDateString("en-US")}`;

      if (!filtered.length) {
        tbody.innerHTML = "<tr><td colspan='9'>No data for this day.</td></tr>";
        return;
      }

      filtered.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDateTime(row.timestamp)}</td>
          <td>${row.JOR || ""}</td>
          <td>${row.DeliveryStaff || ""}</td>
          <td>${row.Comments || ""}</td>
          <td>${row.DeliveryPayMethod || ""}</td>
          <td>${row.PaymentType || ""}</td>
          <td>${createThumbnail(row.media)}</td>
          <td>${createThumbnail(row.media2)}</td>
          <td>${createThumbnail(row.media3)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatDateTime(iso) {
      const date = new Date(iso);
      if (isNaN(date)) return "";
      return date.toLocaleString("en-US", {
        month: '2-digit',
        day: '2-digit',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function createThumbnail(url) {
      if (!url) return "";
      const match = url.match(/[-\w]{25,}/);
      if (!match) return "";
      const fileId = match[0];
      const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}`;
      const fullImageUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
      return `<img src="${thumbnailUrl}" class="thumbnail" onclick="openImagePopup('${fullImageUrl}')">`;
    }

    function openImagePopup(url) {
      const newWin = window.open("", "_blank", "width=600,height=600");
      newWin.document.write(`
        <html>
          <head><title>Image Viewer</title></head>
          <body style="margin:0;text-align:center;">
            <img src="${url}" style="max-width:100%; max-height:100%; object-fit:contain;">
          </body>
        </html>
      `);
    }

    function changeDay(delta) {
      currentDate.setDate(currentDate.getDate() + delta);
      displayDataForDate(currentDate);
    }

    function showAll() {
      const tbody = document.querySelector("#deliveryTable tbody");
      tbody.innerHTML = "";
      document.getElementById("currentDateLabel").textContent = "Showing all deliveries";

      allData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDateTime(row.timestamp)}</td>
          <td>${row.JOR || ""}</td>
          <td>${row.DeliveryStaff || ""}</td>
          <td>${row.Comments || ""}</td>
          <td>${row.DeliveryPayMethod || ""}</td>
          <td>${row.PaymentType || ""}</td>
          <td>${createThumbnail(row.media)}</td>
          <td>${createThumbnail(row.media2)}</td>
          <td>${createThumbnail(row.media3)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

function sortTable(column) {
  if (currentSort.column === column) {
    currentSort.asc = !currentSort.asc; // toggle
  } else {
    currentSort.column = column;
    currentSort.asc = true;
  }

  allData.sort((a, b) => {
    const valA = a[column] || '';
    const valB = b[column] || '';

    if (column === 'timestamp') {
      return currentSort.asc
        ? new Date(valA) - new Date(valB)
        : new Date(valB) - new Date(valA);
    }

    return currentSort.asc
      ? valA.toString().localeCompare(valB.toString())
      : valB.toString().localeCompare(valA.toString());
  });

  displayDataForDate(currentDate);
}    
  </script>
</body>
</html>
