<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lavar Tupi Form</title>
  <link rel="stylesheet" href="lavarcss.css">
  <style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  background: #f2f2f7; /* iOS light gray */
  margin: 0;
  padding: 0;
  color: #1c1c1e;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container {
  max-width: 600px;
  margin: 2rem auto;
  background: #fff;
  padding: 2rem 1.5rem;
  border-radius: 24px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.05);
}

h4 {
  margin-bottom: 1.5rem;
  font-size: 1.7rem;
  font-weight: 600;
  color: #000;
  letter-spacing: -0.4px;
}

a {
  color: #007aff;
  text-decoration: none;
  font-weight: 600;
  margin-right: 1rem;
  font-size: 1rem;
}

a:hover {
  text-decoration: underline;
}

label, p {
  display: block;
  margin: 0 0 6px 0;
  font-weight: 500;
  font-size: 15px;
  color: #3a3a3c;
}

input[type="text"],
input[type="date"],
select {
  width: 100%;
  padding: 14px 16px;
  margin-bottom: 1.5rem;
  font-size: 17px;
  border: 1px solid #d1d1d6;
  border-radius: 16px;
  background: #f9f9f9;
  transition: border-color 0.3s ease;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

input[type="text"]:focus,
input[type="date"]:focus,
select:focus {
  outline: none;
  border-color: #007aff;
  background: #fff;
  box-shadow: 0 0 5px rgba(0, 122, 255, 0.3);
}

#submit {
  width: 100%;
  padding: 16px;
  background: linear-gradient(180deg, #007aff, #005bb5);
  color: white;
  font-size: 18px;
  font-weight: 600;
  border: none;
  border-radius: 24px;
  cursor: pointer;
  transition: background 0.3s ease;
  box-shadow: 0 4px 8px rgba(0,122,255,0.3);
}

#submit:hover {
  background: linear-gradient(180deg, #005bb5, #003f7f);
}

.btn {
  padding: 12px 20px;
  font-size: 16px;
  border-radius: 24px;
  border: none;
  background-color: #efeff4;
  color: #007aff;
  cursor: pointer;
  font-weight: 600;
  box-shadow: none;
  transition: background-color 0.3s ease;
  margin-top: 0.25rem;
}

.btn:hover {
  background-color: #d1d1d6;
}

.mt-2 {
  margin-top: 0.5rem;
}
.mt-3 {
  margin-top: 1rem;
}

.text-danger {
  color: #ff3b30;
  font-weight: 600;
}

.bg-light {
  background-color: #f2f2f7;
}

.border {
  border: 1px solid #d1d1d6;
}

.rounded {
  border-radius: 16px;
}

.p-3 {
  padding: 1rem;
}

.list-group {
  list-style: none;
  padding: 0;
  margin: 0;
}

.list-group-item {
  padding: 12px 16px;
  border-bottom: 1px solid #d1d1d6;
  display: flex;
  justify-content: space-between;
  font-size: 15px;
  color: #1c1c1e;
}

.list-group-item:last-child {
  border-bottom: none;
}

  </style>
</head>
<body>

  <div class="container">
    <div id="joResult" class="border rounded p-3 mt-3 bg-light" style="display:none;"></div>

    <form method="post" action="" name="contact-form">
    <h4>LAVAR FOLDS SUBMISSIONS</h4>
    <a href="pickuprequestsummary.html"> Requests Summary </a> | 
    <a href="pickuprequest.html"> Request Forms </a> | 
    <a href="pickup.html"> Pickup </a>  | 
    <a href="delivery.html"> Delivery </a> | 
    <a href="deliverysummary.html"> DVS </a> |
    <a href="LavarFormSubmission.html"> Fold  </a> <br>  
  <br>
<div class="form-group">
  <label for="joSearch">Search Fold JO/Mga di pa nalolog</label>
  <input type="text" id="joSearch" name="JO NUMBER" placeholder="Enter JO number (e.g. 04065)" />
  <button type="button" class="btn mt-2" onclick="searchFoldJO(); fetchJOInfoFolder(document.getElementById('joSearch').value);">Search</button>
</div>



    <div id="foldJoResult" class="border rounded p-3 mt-3 bg-light" style="display:none;"><br></div>
      <!--<p id="customer-name">Customer Name:</p>

      <label for="jo-number">JO NUMBER (example: 04065... di kasama JO)</label>-->
    <div >
    <label for="pickupDropdown">Select Recent Pickup/Drop - from Request Lists for Pick/Drop-off</label>
   </div> 
    <input type="hidden" id="PickupUID" name="PickupUID" placeholder="UID will appear here" />
    <label for="" style="font-size: 10px;">Customer Name || Date of Pickup/Drop-Off || Delivery Staff</label>
    <select id="pickupDropdown" name="Recent Pickup" class="form-control" >
      <option value="">-- Select Pickup --</option>
    </select>      

      <input type="text" id="customername" name="customername" placeholder="" >
      <label for="folder">Name of Folder</label>
      <select name="NAME OF FOLDER" id="folder" required>
        <option value="">--Select Folder Name--</option>
        <option value="NIDA">NIDA</option>
        <option value="JENNELYN">JENNELYN</option>
        <option value="JERCY">JERCY</option>
        <option value="NORI">NORI</option>        
      </select>    
      <input type="text" id="jo-number" name="JO NUMBER" placeholder="JO NUMBER" hidden>
  
      <div id="joResultFolded" style="display: none; margin-top: 10px; padding: 10px; background-color: #f0f0f0;"></div>
          <label for="datefold">Petsa ng Pagtupi</label>
          <input type="date" id="Date of Fold" name="Date of Fold" required>

          <label for="Time of Folds">Mga Oras ng Pagtupi</label>
          <input type="text" id="Time of Folds" name="Time of Folds" placeholder="Time of Folds" required>

          <label for="bags">Number of Bags</label>
          <input type="text" id="bags" name="NUMBER OF BAGS" placeholder="NUMBER OF BAGS" required>

          <label for="comments">Comments / Name of Customer</label>
          <br>
          <input type="text" id="Comments" name="Comments" placeholder="Comments" required>
        <input type="submit" value="Submit" id="submit">
      </form>
    </div>





  <script>
    //FoldFormSearchJO
 const foldJOWebAppURL = "https://script.google.com/macros/s/AKfycbxyEZI2rcBljv0Yi9-uiVLwH8hkdXahm4KhwCzOx3scYEGTGjSUouPyvI8aGOsDd22R/exec";
 let currentCustomerName = "";  // Global variable to store the name found in searchFoldJO

async function searchFoldJO() {
  const input = document.getElementById("joSearch").value.trim();
  const resultDiv = document.getElementById("foldJoResult");
      const dropdown = document.getElementById("pickupDropdown");
    dropdown.innerHTML = '<option value="">-- Select Pickup --</option>';

  if (!input) {
    resultDiv.style.display = "none";
    return;
  }

  resultDiv.innerHTML = "Searching...";
  resultDiv.style.display = "block";

  try {
    const response = await fetch(`${foldJOWebAppURL}?jo=${encodeURIComponent(input)}`);
    const data = await response.json();

    if (data.error || !data.match) {
      resultDiv.innerHTML = `<div class="text-danger">JO #${input} not found.</div>`;
      return;
    }

    const joData = data.match;
    const headers = ["Date Created", "JO", "Customer Name", "Amount"];
    
    let html = `<ul class="list-group">`;
    headers.forEach((header, index) => {
      let value = joData[index] || "";

      if (header === "Date Created") {
        value = formatDateTime(value);
      }

      if (header === "Customer Name") {
        const customerInput = document.getElementById("customername");
        if (customerInput) customerInput.value = value;
        currentCustomerName = value.trim().toLowerCase();  // set global variable

        // *** CALL loadPickupDropdown HERE ***
        loadPickupDropdown();
        
      }
      html += `
        <li class="list-group-item d-flex justify-content-between">
          <strong>${header}</strong>
          <span>${value}</span>
        </li>`;
    });
    html += `</ul>`;
          
    resultDiv.innerHTML = html;

    // Optionally set JO number field here if needed
    const joIndex = headers.indexOf("JO#");
    if (joIndex !== -1) {
      document.getElementById("jo-number").value = joData[joIndex] || "";
    }

  } catch (err) {
    resultDiv.innerHTML = `<div class="text-danger">Error fetching JO: ${err.message}</div>`;
  }
}

 

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      const options = {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", hour12: true
      };
      return new Intl.DateTimeFormat("en-US", options).format(date);
    }

    //FoldFormSearchPickups
const pickupWebAppURL = "https://script.google.com/macros/s/AKfycbz_gvAtAjY3ecsNhm6fjBDli-Uu4Uq6OxKWDH5b3rZDLkUHGfWKrLB6FWDLE2N5HKoB/exec";

function formatDate(input) {
  const d = new Date(input);
  return d.toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric'
  });
}

async function loadPickupDropdown() {
  try {
    const response = await fetch(pickupWebAppURL);
    const data = await response.json();

    const dropdown = document.getElementById("pickupDropdown");
    dropdown.innerHTML = '<option value="">-- Select Pickup --</option>';

    let matchCount = 0;

data.result.forEach(item => {
  const pickupName = item.name?.trim().toLowerCase() || "";

  if (pickupName === currentCustomerName) {
    const label = `${item.name} || ${formatDate(item.dateofpickup)} || ${item.pickuplocation} || ${item.deliveryStaff} || ${item.requestType} | ${item.UID} `;
    const option = document.createElement("option");
    option.value = label;
    option.textContent = label;
    dropdown.appendChild(option);

    matchCount++;  // <---- THIS WAS MISSING
  }
});


    if (matchCount === 0) {
      const option = document.createElement("option");
      option.disabled = true;
      option.textContent = "No matching pickups found";
      dropdown.appendChild(option);
    }

  } catch (error) {
    console.error("Failed to load pickup data:", error);
  }
  console.log("currentCustomerName =", currentCustomerName);
}


//NewFormFoldsSubmit - web app
//https://script.google.com/macros/s/AKfycbwXHl1Pp9_JX93hamXEduNQJNHCumC3P-tCI2EVD0g_-P5SGP_zVFUmBwi-g2AaHmIboA/exec

document.forms["contact-form"].addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // Try to find submit button (button or input)
  let submitButton = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
  let originalButtonText;


  if (submitButton) {
    submitButton.disabled = true;
    originalButtonText = submitButton.textContent || submitButton.value;
    if (submitButton.tagName === "BUTTON") {
      submitButton.textContent = "Submitting...";
    } else {
      submitButton.value = "Submitting...";
    }
  }

  const data = {
    "JO NUMBER": formData.get("JO NUMBER"),
    "NUMBER OF BAGS": formData.get("NUMBER OF BAGS"),
    "NAME OF FOLDER": formData.get("NAME OF FOLDER"),
    "Time of Folds": formData.get("Time of Folds"),
    "Comments": formData.get("Comments"),
    "Date of Fold": formData.get("Date of Fold"),
    "PickupUID": formData.get("PickupUID") 
  };

  try {
      //NewFormFoldsSubmit
    const response = await fetch("https://script.google.com/macros/s/AKfycbwXHl1Pp9_JX93hamXEduNQJNHCumC3P-tCI2EVD0g_-P5SGP_zVFUmBwi-g2AaHmIboA/exec", {
      method: "POST",
      body: new URLSearchParams(data),
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      }
    });

    const resultText = await response.text();

    if (resultText.trim() === "Success") {
      alert("Submission successful!");
      location.reload(); 
    } else {
      alert("Submission failed: " + resultText);
    }
  } catch (error) {
    console.error("Submit error:", error);
    alert("Submission failed. Please try again.");
  } finally {
    if (submitButton) {
      submitButton.disabled = false;
      if (submitButton.tagName === "BUTTON") {
        submitButton.textContent = originalButtonText;
      } else {
        submitButton.value = originalButtonText;
      }
    }
  }
});

</script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
    document.getElementById("Date Of Fold").value = today;
  });
document.getElementById("pickupDropdown").addEventListener("change", function () {
  const selectedValue = this.value;
  const uidMatch = selectedValue.match(/UID-[\w:-]+/); // Match UID- followed by any word, colon, or dash

  if (uidMatch) {
    document.getElementById("PickupUID").value = uidMatch[0]; // Set the UID in the input
  } else {
    document.getElementById("PickupUID").value = ""; // Clear if UID not found
  }
});

//searchForFoldedJO
  async function fetchJOInfoFolder(joNumber) {
    const webAppUrl = "https://script.google.com/macros/s/AKfycbyHz5ij5C0Iw9PWMQfk1W-rAYMZxQ0jrzst-C-emrQve_kUeo4_FSrsOsCmQi39z8C8zw/exec";

    if (!joNumber) {
      alert("Please enter a JO number.");
      return;
    }

    try {
      const response = await fetch(`${webAppUrl}?jo=${encodeURIComponent(joNumber)}`);
      const text = await response.text();
      console.log("Response:", text);
      
      try {
        const data = JSON.parse(text);
        const formattedG = new Date(data.G).toLocaleString();
        const formattedM = new Date(data.M).toLocaleString();

        const resultDiv = document.getElementById("joResultFolded");
        resultDiv.style.display = "block";
        
        resultDiv.innerHTML = `
          <strong>JO#:</strong> ${data.JO}<br>
          <strong>Folder:</strong> ${data.D}<br>
          <strong>Time of Fold:</strong> ${formattedG}<br>
          <strong>Customer Name:</strong> ${data.J}<br>
          <strong>Date JO# Created:</strong> ${formattedM}
        `;
      } catch (e) {
        //document.getElementById("joResultFolded").style.display = "block";
        //document.getElementById("joResultFolded").innerHTML = `<span style="color: red;">JO# not found.</span>`;
      }
    } catch (error) {
      console.error("Fetch failed:", error);
      document.getElementById("joResultFolded").style.display = "block";
      document.getElementById("joResultFolded").innerHTML = `<span style="color: red;">Error fetching JO data.</span>`;
    }
  }




</script>

</body>
</html>