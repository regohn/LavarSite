<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lavar Tupi Form</title>
  <link rel="stylesheet" href="lavarcss.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h4 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
      color: #343a40;
    }

    label, p {
      margin: 0.5rem 0 0.2rem;
      font-weight: 500;
      font-size: 14px;
      color: #333;
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 1rem;
      border: 1px solid #ced4da;
      border-radius: 5px;
      font-size: 14px;
    }

    #submit {
      width: 100%;
      padding: 10px;
      background: #007bff;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #submit:hover {
      background: #0056b3;
    }

    .btn {
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      background-color: #6c757d;
      color: white;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #5a6268;
    }

    .mt-2 { margin-top: 0.5rem; }
    .mt-3 { margin-top: 1rem; }
    .text-danger { color: red; }
    .bg-light { background-color: #f1f1f1; }
    .border { border: 1px solid #ccc; }
    .rounded { border-radius: 5px; }
    .p-3 { padding: 1rem; }
  </style>
</head>
<body>

  <div class="container">
    <div id="joResult" class="border rounded p-3 mt-3 bg-light" style="display:none;"></div>

    <form method="post" action="" name="contact-form">
    <h4>LAVAR FOLDS SUBMISSIONS</h4>

    <div class="form-group">
      <label for="joSearch">Search Fold JO/Mga di pa nalolog</label>
      <input type="text" id="joSearch" name="JO NUMBER" placeholder="Enter JO number (e.g. 04065)" />
      <button type="button" class="btn mt-2" onclick="searchFoldJO()">Search</button>
    </div>

<div id="foldJoResult" class="border rounded p-3 mt-3 bg-light" style="display:none;"></div>
      <!--<p id="customer-name">Customer Name:</p>

      <label for="jo-number">JO NUMBER (example: 04065... di kasama JO)</label>-->

    <label for="pickupDropdown">Select Recent Pickup/Drop - from Request Lists for Pick/Drop-off</label>
    <br> 
    <label for="" style="font-size: 10px;">Customer Name || Date of Pickup/Drop-Off || Delivery Staff</label>
    <select id="pickupDropdown" name="Recent Pickup">
      <option value="">-- Select Pickup --</option>
    </select>      
      <input type="text" id="jo-number" name="JO NUMBER" placeholder="JO NUMBER" hidden>
      <input type="text" id="customername" name="customername" placeholder="" hidden >
      <label for="folder">Name of Folder</label>
      <select name="NAME OF FOLDER" id="folder" required>
        <option value="">--Select Folder Name--</option>
        <option value="NIDA">NIDA</option>
        <option value="JENNELYN">JENNELYN</option>
        <option value="JERCY">JERCY</option>
        <option value="NORI">NORI</option>        
      </select>

        <label for="datefold">Petsa ng Pagtupi</label>
        <input type="date" id="Date of Fold" name="Date of Fold" required>

        <label for="Time of Folds">Mga Oras ng Pagtupi</label>
        <input type="text" id="Time of Folds" name="Time of Folds" placeholder="Time of Folds" required>

        <label for="bags">Number of Bags</label>
        <input type="text" id="bags" name="NUMBER OF BAGS" placeholder="NUMBER OF BAGS" required>

        <label for="comments">Comments / Name of Customer</label>
        <br>
        <input type="text" id="Comments" name="Comments" placeholder="Comments" required>
      <input type="submit" value="Submit" id="submit">
    </form>
  </div>


  <script>
 const foldJOWebAppURL = "https://script.google.com/macros/s/AKfycbyH6sL6rCPE04OY1U9CC7oxYDo_PEwsXH7LRXUS85p-XU7oBqxE-r8O2Yf0sKZr0HtFPg/exec";
 let currentCustomerName = "";  // Global variable to store the name found in searchFoldJO

async function searchFoldJO() {
  const input = document.getElementById("joSearch").value.trim();
  const resultDiv = document.getElementById("foldJoResult");
      const dropdown = document.getElementById("pickupDropdown");
    dropdown.innerHTML = '<option value="">-- Select Pickup --</option>';

  if (!input) {
    resultDiv.style.display = "none";
    return;
  }

  resultDiv.innerHTML = "Searching...";
  resultDiv.style.display = "block";

  try {
    const response = await fetch(`${foldJOWebAppURL}?jo=${encodeURIComponent(input)}`);
    const data = await response.json();

    if (data.error || !data.match) {
      resultDiv.innerHTML = `<div class="text-danger">JO #${input} not found.</div>`;
      return;
    }

    const joData = data.match;
    const headers = ["Date Created", "JO", "Customer Name", "Amount"];
    
    let html = `<ul class="list-group">`;
    headers.forEach((header, index) => {
      let value = joData[index] || "";

      if (header === "Date Created") {
        value = formatDateTime(value);
      }

      if (header === "Customer Name") {
        const customerInput = document.getElementById("customername");
        if (customerInput) customerInput.value = value;
        currentCustomerName = value.trim().toLowerCase();  // set global variable

        // *** CALL loadPickupDropdown HERE ***
        loadPickupDropdown();
      }
      html += `
        <li class="list-group-item d-flex justify-content-between">
          <strong>${header}</strong>
          <span>${value}</span>
        </li>`;
    });
    html += `</ul>`;
          
    resultDiv.innerHTML = html;

    // Optionally set JO number field here if needed
    const joIndex = headers.indexOf("JO#");
    if (joIndex !== -1) {
      document.getElementById("jo-number").value = joData[joIndex] || "";
    }

  } catch (err) {
    resultDiv.innerHTML = `<div class="text-danger">Error fetching JO: ${err.message}</div>`;
  }
}

 

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      const options = {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", hour12: true
      };
      return new Intl.DateTimeFormat("en-US", options).format(date);
    }

const pickupWebAppURL = "https://script.google.com/macros/s/AKfycbz_gvAtAjY3ecsNhm6fjBDli-Uu4Uq6OxKWDH5b3rZDLkUHGfWKrLB6FWDLE2N5HKoB/exec";

function formatDate(input) {
  const d = new Date(input);
  return d.toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric'
  });
}

async function loadPickupDropdown() {
  try {
    const response = await fetch(pickupWebAppURL);
    const data = await response.json();

    const dropdown = document.getElementById("pickupDropdown");
    dropdown.innerHTML = '<option value="">-- Select Pickup --</option>';

    let matchCount = 0;

data.result.forEach(item => {
  const pickupName = item.name?.trim().toLowerCase() || "";

  if (pickupName === currentCustomerName) {
    const label = `${item.name} || ${formatDate(item.dateofpickup)} || ${item.deliveryStaff}`;
    const option = document.createElement("option");
    option.value = label;
    option.textContent = label;
    dropdown.appendChild(option);

    matchCount++;  // <---- THIS WAS MISSING
  }
});


    if (matchCount === 0) {
      const option = document.createElement("option");
      option.disabled = true;
      option.textContent = "No matching pickups found";
      dropdown.appendChild(option);
    }

  } catch (error) {
    console.error("Failed to load pickup data:", error);
  }
  console.log("currentCustomerName =", currentCustomerName);
}


//NewFormFoldsSubmit - web app
//https://script.google.com/macros/s/AKfycbwXHl1Pp9_JX93hamXEduNQJNHCumC3P-tCI2EVD0g_-P5SGP_zVFUmBwi-g2AaHmIboA/exec

document.forms["contact-form"].addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // Disable the submit button and show "Submitting..."
  const submitButton = form.querySelector('button[type="submit"]');
  submitButton.disabled = true;
  const originalButtonText = submitButton.textContent;
  submitButton.textContent = "Submitting...";

  const data = {
    "JO NUMBER": formData.get("JO NUMBER"),
    "NUMBER OF BAGS": formData.get("NUMBER OF BAGS"),
    "NAME OF FOLDER": formData.get("NAME OF FOLDER"),
    "Time of Folds": formData.get("Time of Folds"),
    "Comments": formData.get("Comments"),
    "Date of Fold": formData.get("Date of Fold")
  };

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwXHl1Pp9_JX93hamXEduNQJNHCumC3P-tCI2EVD0g_-P5SGP_zVFUmBwi-g2AaHmIboA/exec", {
      method: "POST",
      body: new URLSearchParams(data),
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      }
    });

    const resultText = await response.text();

    if (resultText.trim() === "Success") {
      alert("Submission successful!");
      location.reload(); 
    } else {
      alert("Submission failed: " + resultText);
    }
  } catch (error) {
    console.error("Submit error:", error);
    alert("Submission failed. Please try again.");
  } finally {
    // Re-enable the button and reset its label
    submitButton.disabled = false;
    submitButton.textContent = originalButtonText;
  }
});

</script>

</body>
</html>
