<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Customer Issues - Past 12 Months</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-color: #1e3a8a;
      --secondary-color: #f3f4f6;
      --text-color: #111827;
      --border-color: #e5e7eb;
      --highlight-color: #fef3c7;
    }
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 10px;
      background-color: var(--secondary-color);
      color: var(--text-color);
      height: 100%;
      overflow: hidden;
    }
    .container {
      width: 50vw;
      height: 80vh;
      margin: 5vh auto;
      padding: 1rem;
      background: white;
      overflow-y: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.6rem;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    thead {
      background-color: var(--primary-color);
      color: white;
    }
    th, td {
      padding: 0.6rem;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      vertical-align: top;
      font-size: 1rem;
    }
    tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }
    tbody tr:hover {
      background-color: var(--highlight-color);
    }
    .loading, .no-data {
      text-align: center;
      padding: 2rem;
      font-size: 1rem;
    }
    #customerDropdown {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Customer Issues (Past 12 Months)</h2>
    <select id="customerDropdown">
      <option value="">All Customers</option>
    </select>
    <div class="table-wrapper" id="issueContainer">
      <p class="loading">Loading issues...</p>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzS9Ve7k065Jl5CVNZHmnonGPOb-xhZx-tIWBf0tQC78kFopDSLyPInqziklmGsVqmQ/exec";
    const SHEET_NAME = "AdminComments";
    let allIssues = [];

    async function fetchIssues() {
      try {
        const res = await fetch(`${WEB_APP_URL}?sheet=${SHEET_NAME}`);
        const data = await res.json();

        const twelveMonthsAgo = new Date();
        twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);

        allIssues = data
          .filter(row => {
            const ts = new Date(row['TimeStamp']);
            return !isNaN(ts) && ts >= twelveMonthsAgo;
          })
          .sort((a, b) => new Date(b['TimeStamp']) - new Date(a['TimeStamp']));

        populateDropdown(allIssues);
        renderTable(allIssues);
      } catch (err) {
        document.getElementById("issueContainer").innerHTML = `<p class="no-data">Error loading issues: ${err.message}</p>`;
      }
    }

    function populateDropdown(data) {
      const dropdown = document.getElementById("customerDropdown");
      const customers = [...new Set(data.map(d => (d["CustomerName"] || "").trim()).filter(c => c !== ""))];
      customers.forEach(cust => {
        const option = document.createElement("option");
        option.value = cust;
        option.textContent = cust;
        dropdown.appendChild(option);
      });

      dropdown.addEventListener("change", () => {
        const selectedCustomer = dropdown.value;
        const filtered = selectedCustomer
          ? allIssues.filter(issue => (issue["CustomerName"] || "").trim() === selectedCustomer)
          : allIssues;
        renderTable(filtered);
      });
    }

    function renderTable(data) {
      if (!data.length) {
        document.getElementById("issueContainer").innerHTML = `<p class="no-data">No issues in the past 12 months.</p>`;
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>JO#</th>
              <th>Customer</th>
              <th>Comments</th>
              <th>Timestamp</th>
              <th>Resolution</th>
            </tr>
          </thead>
          <tbody>`;

      data.forEach(row => {
        html += `
          <tr>
            <td>${row['JO#'] || ''}</td>
            <td>${row['CustomerName'] || ''}</td>
            <td>${row['Comments'] || ''}</td>
            <td>${formatDate(row['TimeStamp'])}</td>
            <td>${row['Resolution'] || ''}</td>
          </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("issueContainer").innerHTML = html;
    }

    function formatDate(iso) {
      const date = new Date(iso);
      return isNaN(date) ? '' : date.toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: true
      });
    }

    fetchIssues();
  </script>
</body>
</html>
