<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Image Viewer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f2f2f7;
      margin: 0;
      padding: 20px;
      color: #1c1c1e;
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #0a84ff;
    }

    input[type="date"] {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }

    .image-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .image-grid img {
      width: 140px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .image-grid img:hover {
      transform: scale(1.05);
    }

    .summary {
      margin-top: 40px;
    }

    .summary-date {
      font-weight: bold;
      margin-top: 10px;
    }

    .summary-thumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .summary-thumbs img {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }

    /* Lightbox viewer (now just a placeholder/container for the close button) */
    .lightbox {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      z-index: 999;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Remove image specific styles from lightbox as it's no longer displaying the image */
    /* .lightbox img { ... } */
    /* .lightbox-controls { ... } */
    /* .nav-button { ... } */

    .close-button {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      color: white;
      cursor: pointer;
    }

    .link-wrapper {
      text-align: center;
      margin-bottom: 20px;
    }

    .link-wrapper a {
      display: inline-block;
      padding: 10px 15px;
      background-color: #e0e0e0;
      border-radius: 12px;
      text-decoration: none;
      color: #0a84ff;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .link-wrapper a:hover {
      background-color: #d0d0d0;
    }
  </style>
</head>
<body>

  <h2>View Uploaded Images</h2>
    <div class="link-wrapper">
    <a href="dailyreport.html">Upload Daily Report</a>
  </div>
  <input type="date" id="datePicker" />

  <div class="image-grid" id="imageContainer"></div>

  <div class="summary" id="summaryContainer">
    <h3>Summary by Date</h3>
  </div>

  <!-- Lightbox viewer - simplified as it now just opens a new tab -->
  <div class="lightbox" id="lightbox">
    <span class="close-button" onclick="closeLightbox()">×</span>
    <!-- The image and navigation controls are no longer needed here as the image opens in a new tab -->
    <!-- <img id="lightboxImage" src="" onerror="this.onerror=null;this.src='https://placehold.co/600x400/FF0000/FFFFFF?text=Image+Load+Error'; console.error('Failed to load image:', this.src);"> -->
    <!-- <div class="lightbox-controls"> -->
      <!-- <span class="nav-button" onclick="prevImage()">⟨</span> -->
      <!-- <span class="nav-button" onclick="nextImage()">⟩</span> -->
    <!-- </div> -->
  </div>

  <script>
    const webAppURL = "https://script.google.com/macros/s/AKfycbxXPGJSr3b86WWY_lYWPivLqa_9cYFkKmjMtoEXZwd17kqZspTv_KQDNuVhBlKX5zmmQQ/exec?action=getImages";
    let allData = {};
    let currentImages = []; // This will now store objects {thumbnailUrl, fullImageUrl}
    let currentIndex = 0;

    async function fetchData() {
      try {
        const res = await fetch(webAppURL);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        allData = await res.json();
        populateSummary(allData);
      } catch (error) {
        console.error("Error fetching data:", error);
        // Optionally, display an error message to the user
        // document.getElementById("status").innerText = "Failed to load images.";
      }
    }

    function populateSummary(data) {
      const container = document.getElementById("summaryContainer");
      container.innerHTML = '<h3>Summary by Date</h3>';

      Object.keys(data).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
        const div = document.createElement("div");
        div.innerHTML = `<div class="summary-date">${date}</div>`;
        const thumbWrap = document.createElement("div");
        thumbWrap.className = "summary-thumbs";
        data[date].forEach(imageObject => { // Iterate over image objects
          const img = document.createElement("img");
          img.src = imageObject.thumbnailUrl; // Use thumbnailUrl for summary
          thumbWrap.appendChild(img);
        });
        div.appendChild(thumbWrap);
        container.appendChild(div);
      });
    }

    function displayImages(date) {
      const container = document.getElementById("imageContainer");
      container.innerHTML = "";

      currentImages = allData[date] || [];
      currentImages.forEach((imageObject, index) => { // Iterate over image objects
        const img = document.createElement("img");
        img.src = imageObject.thumbnailUrl; // Use thumbnailUrl for grid
        img.onclick = () => openLightbox(index); // This will now open a new tab
        container.appendChild(img);
      });
    }

    function openLightbox(index) {
      // No need to set display:flex for the lightbox if we're opening a new tab
      // document.getElementById("lightbox").style.display = "flex";
      const fullImageUrl = currentImages[index].fullImageUrl;
      console.log("Opening full image in new tab from:", fullImageUrl);
      window.open(fullImageUrl, '_blank'); // Open the full image in a new tab
    }

    function closeLightbox() {
      // This function might become less relevant if we're always opening new tabs,
      // but keeping it for now in case you want to reuse the lightbox for other purposes.
      document.getElementById("lightbox").style.display = "none";
    }

    // These functions are no longer directly used for image display in the lightbox
    // as the image opens in a new tab.
    function prevImage() {
      // if (currentImages.length === 0) return;
      // currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      // const fullImageUrl = currentImages[currentIndex].fullImageUrl;
      // document.getElementById("lightboxImage").src = fullImageUrl;
      // console.log("Attempting to load full image from:", fullImageUrl);
    }

    function nextImage() {
      // if (currentImages.length === 0) return;
      // currentIndex = (currentIndex + 1) % currentImages.length;
      // const fullImageUrl = currentImages[currentIndex].fullImageUrl;
      // document.getElementById("lightboxImage").src = fullImageUrl;
      // console.log("Attempting to load full image from:", fullImageUrl);
    }

    document.getElementById("datePicker").addEventListener("change", e => {
      const selectedDate = e.target.value;
      displayImages(selectedDate);
    });

    fetchData();
  </script>

</body>
</html>
