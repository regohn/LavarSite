<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Form - LAVAR LAUNDRY</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.all.min.js"></script>
    <style>
      .form-container {
        max-width: 500px;
        margin: auto;
        margin-top: 50px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background-color: #fff;
      }

        .button-container {
        display: flex;
        gap: 5px; /* Adds space between the buttons */
        align-items: center; /* Aligns buttons vertically if they have different heights */
        }

        button {
        padding: 10px 10px;
        font-size: 10px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background-color: #4CAF50;
        color: white;
        }

        button:hover {
        background-color: #45a049;
        }      
    </style>
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="form-container">
        <h4 class="text-center mb-4">Lavar Laundry Delivery Form</h4>
        <div>
        <a href="pickuprequestsummary.html"> Requests Summary </a> | <a href="pickuprequest.html"> Request Forms </a> | <a href="pickup.html"> Pickup </a>  | <a href="delivery.html"> Delivery </a> | <a href="deliverysummary.html"> DVS </a> <br>

        </div>
        <form id="submit-to-google-sheet">
          <div class="form-group">
            <label for="JOR">Job Order Reference <br>(Only Folded Laundry JOs will appear in search)<br> (Use Delivery form also for In-shop Pickup of laundry by customer)</label>
            <input
                class="form-control"
                type="text"
                name="JOR"
                id="JOR"
                placeholder="Enter Job Order Ref"
                required
                readonly
            />
            <input
                class="form-control mt-2"
                type="text"
                id="JOsearch"
                placeholder="Search for JO..."
                oninput="searchJO()"
                
            />
            
            </div>
            <div>
            <button id="searchButton" type="button">Search</button>
            <button id="clearButton" onclick="clearInput()">Clear</button>
            </div>    
            <div id="JOresult"></div>
            
        <!--
          <div class="form-group">
            <label for="LocationofDelivery">Location of Delivery</label>
            <input
              class="form-control"
              type="text"
              name="LocationofDelivery"
              id="LocationofDelivery"
              placeholder="Delivery Location"
              required
            />
          </div>
        
          <div class="form-group">
            <label for="DateofDelivery">Date of Delivery</label>
            <input
              class="form-control"
              type="date"
              name="DateofDelivery"
              id="DateofDelivery"
              required
            />
          </div>
       
          <div class="form-group">
            <label for="TimeofDelivery">Time of Delivery</label>
            <input
              class="form-control"
              type="text"
              name="TimeofDelivery"
              id="TimeofDelivery"
              placeholder="Time of Delivery"
              required
            />
          </div>
        --> 

          <div class="form-group">
            <label for="DeliveryStaff">Delivery Staff</label>
            <select class="form-control" name="DeliveryStaff" id="DeliveryStaff" required>
              <option value="" disabled selected hidden>Choose...</option>
              <option value="Joshua">Joshua</option>
              <option value="Marvin">Marvin</option>
              <option value="Lowi">LOWI</option>
              <option value="Edward">EDWARD</option>
              <option value="MIA">MIA</option>
              <option value="NIDA">NIDA</option>
            </select>
          </div>

          <div class="form-group">
            <table>
              <tr>
                <!-- Column 1: Yes/No -->
                <td>
                  <label>Did the Customer Pay During Delivery?</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="DeliveryPayMethod" id="payYes" value="Yes" required onchange="togglePaymentOptions(true)">
                    <label class="form-check-label" for="payYes">Yes</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="DeliveryPayMethod" id="payNo" value="No" onchange="togglePaymentOptions(false)">
                    <label class="form-check-label" for="payNo">No</label>
                  </div>
                </td>
                   <td>
                    
                   </td>
                <!-- Column 2: Conditional Payment Options -->
                <td id="paymentTypeColumn" style="display: none;">
                  <label>Payment Method</label>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="PaymentType" id="cash" value="Cash">
                    <label class="form-check-label" for="cash">Cash</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="PaymentType" id="gcash" value="G-Cash">
                    <label class="form-check-label" for="gcash">G-Cash</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="PaymentType" id="others" value="Others">
                    <label class="form-check-label" for="others">Others</label>
                  </div>
                </td>
              </tr>
            </table>
          </div>

          <div class="form-group">
            <label for="Comments">Comments/Notes: Include Delivery Location</label>
            <textarea
              class="form-control"
              name="Comments"
              id="Comments"
              placeholder="Message"
              rows="4"
              required
            ></textarea>
          </div>

          <div class="form-group mt-2">
            <label for="media">Upload First Picture</label>
            <input class="form-control-file" type="file" name="media" id="media" />
          </div>

          <div class="form-group mt-2">
            <label for="media2">Upload Second Picture</label>
            <input class="form-control-file" type="file" name="media2" id="media2" />
          </div>

          <div class="form-group mt-2">
            <label for="media3">Upload Third Picture</label>
            <input class="form-control-file" type="file" name="media3" id="media3" />
          </div>

          <button id="mainsubmitbutton" type="submit" class="btn btn-primary btn-block">Submit</button>
        </form>
      </div>
    </div>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbyvt6V7CiOvjDjqcKrRpVNXgCj9AS912tgj21unL8ysnQVyiW0YELCiKE5A88Fle9K-/exec";
  const form = document.forms["submit-to-google-sheet"];
  const JOsearchField = document.getElementById("JOsearch");
  const JOresult = document.getElementById("JOresult");

  // Grab the search button and add the event listener
  const searchButton = document.getElementById("searchButton");



function getDriveThumbnail(url) {
  const match = url.match(/[-\w]{25,}/);
  return match ? `https://drive.google.com/thumbnail?id=${match[0]}` : "";
}

  searchButton.addEventListener("click", async function () {
    const joNumber = JOsearchField.value.trim();
    if (joNumber) {
      const response = await fetch(`${scriptURL}?JO=${joNumber}`);
      const data = await response.json();
      
          let picturesHTML = "";

          if (data.Picture1) {
            picturesHTML += `
              <div>
                <table>
                  <tr>
                    <td>Picture1:</td>
                    <td>
                      <a href="${data.Picture1}" target="_blank">
                        <img id="pic1img" src="${getDriveThumbnail(data.Picture1)}" alt="Picture1" style="height: 60px; margin: 5px; border-radius: 5px;" />
                      </a>
                    </td>
                    <td>
                      <button id="Pic1Delete"  onclick="deletePicture(1)" type="button" style="height: 20px; display: flex; align-items: center; justify-content: center; padding: 0 10px;">Delete</button>
                  </tr>
              </div>`;
          }
          if (data.Picture2) {
            picturesHTML += `
              <div>
                <table>
                  <tr>
                    <td>Picture2:</td>
                    <td>
                      <a href="${data.Picture2}" target="_blank">
                        <img id="pic2img" src="${getDriveThumbnail(data.Picture2)}" alt="Picture2" style="height: 60px; margin: 5px; border-radius: 5px;" />
                      </a>
                    </td>
                    <td>
                      <button id="Pic2Delete"  onclick="deletePicture(2)"  type="button" style="height: 20px; display: flex; align-items: center; justify-content: center; padding: 0 10px;">Delete</button>
                  </tr>
              </div>`;
          }
          if (data.Picture3) {
            picturesHTML += `
              <div>
                <table>
                  <tr>
                    <td>Picture3:</td>
                    <td>
                      <a href="${data.Picture3}" target="_blank">
                        <img id="pi31img" src="${getDriveThumbnail(data.Picture3)}" alt="Picture3" style="height: 60px; margin: 5px; border-radius: 5px;" />
                      </a>
                    </td>
                    <td>
                      <button id="Pic3Delete" onclick="deletePicture(3)"  type="button" style="height: 20px; display: flex; align-items: center; justify-content: center; padding: 0 10px;">Delete</button>
                  </tr>

              </div>`;
          }

      if (data.result === "not found") {
        JOresult.innerHTML = "Di Pa Na Log ng Mga Nagtupi. Tawagan sila at ipalog.";
      } else {
        const formattedDeliveryDatetime = formatDateTime(data.DeliveryTimeStamp);
        if (data.JO && (!data.DeliveryStaff || data.DeliveryStaff.trim() === "")) {
          document.getElementById("JOR").value = data.JO;
          const submitButton = document.querySelector("button[type='submit']");
          submitButton.disabled = false;
          submitButton.innerText = "SUBMIT";          
        }        
        JOresult.innerHTML = `
          <div style="font-size: 11px;">
            <br>Customer Name: ${data.value} <br>
            JO#: ${data.JO} <br>
            No. of Bags: ${data.colC} <br>
            Total Amount: ${data.colK} <br>
            Folder: ${data.colD} <br>
            Details: ${data.colE} <br><br>
            Delivered By: ${data.DeliveryStaff} <br>
            Comments: ${data.Comments} <br>
            Date of Delivery: ${formattedDeliveryDatetime} <br>
            Delivery ID: ${data.UniqueID} <p id="deliveryid" style="color: white;">${data.UniqueID}</p> ${picturesHTML}
            <input type="hidden" id="UniqueID" name="UniqueID" value="${data.UniqueID || ''}">
          </div>
        `;

// After setting JOresult.innerHTML and before ending the else block
    if (data.DeliveryStaff && data.DeliveryStaff.trim() !== "") {
      // Disable form fields
          //document.getElementById("DeliveryStaff").disabled = true;
          //document.getElementById("Comments").disabled = true; 

          document.getElementById("JOR").disabled = false;
          document.getElementById("JOR").value = data.JO;
          document.getElementById("DeliveryStaff").value = data.DeliveryStaff;
          document.getElementById("Comments").value = data.Comments;
          document.getElementById("DeliveryPayMethod").value = data.DeliveryPayMethod;

          //document.getElementById("media").disabled = true;
          //document.getElementById("media2").disabled = true;
          //document.getElementById("media3").disabled = true;
        
          const submitButton = document.querySelector("button[type='submit']");
          submitButton.disabled = false;
          submitButton.innerText = "Update";

      } else if (!data.DeliveryStaff || data.DeliveryStaff.trim() === "") {
        // If DeliveryStaff is missing/empty, prefill the JOR field with JO
          document.getElementById("DeliveryStaff").disabled = false;
          document.getElementById("Comments").disabled = false; 

          document.getElementById("JOR").disabled = false;
          document.getElementById("media").disabled = false;
          document.getElementById("media2").disabled = false;
          document.getElementById("media3").disabled = false;
      }
    
    
      }
    } else {
      JOresult.innerHTML = "Please enter a JO number.";
    }
  });

document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("submit-to-google-sheet");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const fileInputs = ["media", "media2", "media3"];

    for (const id of fileInputs) {
      const input = document.getElementById(id);
      if (input.files.length > 0) {
        const file = input.files[0];
        if (file.size > 5 * 1024 * 1024) {
          swal("Error", `${id} must be less than 5MB.`, "error");
          return;
        }
        const base64 = await readFileAsBase64(file);
        formData.set(id, base64);
      }
    }

    await submitForm(formData);
  });

  async function submitForm(formData) {
    try {
      const response = await fetch("https://script.google.com/macros/s/AKfycbyvt6V7CiOvjDjqcKrRpVNXgCj9AS912tgj21unL8ysnQVyiW0YELCiKE5A88Fle9K-/exec", {
        method: "POST",
        body: formData,
      });
      const result = await response.json();

      if (result.result === "success") {
        // Update hidden unique_id input with the server-generated unique_id
        if (result.unique_id) {
          const uniqueIdInput = document.getElementById("UniqueID") || document.querySelector('input[name="unique_id"]');
          if (uniqueIdInput) {
            uniqueIdInput.value = result.unique_id;
          }
        }
        swal("Success", "Record saved successfully!", "success");
      } else {
        swal("Error", result.error || "Unknown error", "error");
      }
    } catch (err) {
      swal("Error", err.message || "Network error", "error");
    }
  }

  // Helper function to convert file to base64 string
  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]); // get base64 without prefix
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }
});


function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

console.log("Form submitted");

  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

async function submitForm(formData) {
  const JOR = formData.get("JOR");
  if (!JOR || JOR.trim() === "") {
    swal("Missing JO#", "Please enter the Job Order Reference before submitting.", "warning");
    return; // Stop the function if JOR is empty
  }

  const submitButton = document.querySelector("button[type='submit']");
  submitButton.disabled = true;
  submitButton.innerText = "Loading...";

  fetch(scriptURL, { method: "POST", body: formData })
    .then((response) => {
      swal("Done", "Submitted Successfully.", "success");
      location.reload();
      //form.reset();
    })
    .catch((error) => {
      swal("Error", "Something went wrong. Please try again!", "error");
    })
    .finally(() => {
      submitButton.disabled = false;
      submitButton.innerText = "Submit";
    });
}




function clearInput() {
  // Clear the content of the JOsearch input field
  document.getElementById("JOresult").innerHTML = "";
  document.getElementById("JOR").value = "";
  document.getElementById("JOsearch").value = "";
}


function copyJO(joNumber) {
    document.getElementById("JOR").value = joNumber;
    document.getElementById("JOsearch").value = "";  
}

function formatDateTime(timestamp) {
  const date = new Date(timestamp);

  const mm = String(date.getMonth() + 1).padStart(2, "0");
  const dd = String(date.getDate()).padStart(2, "0");
  const yyyy = date.getFullYear();

  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, "0");
  const ampm = hours >= 12 ? "pm" : "am";

  hours = hours % 12;
  hours = hours ? hours : 12; // 0 should be 12

  return `${mm}/${dd}/${yyyy} ${hours}:${minutes} ${ampm}`;
}


  function deletePicture(picNumber) {
    const fileInputId = picNumber === 1 ? 'media' : `media${picNumber}`;
    const imgId = `pic${picNumber}img`;

    document.getElementById("mainsubmitbutton").innerHTML = "Submit";

    const fileInput = document.getElementById(fileInputId);
    const img = document.getElementById(imgId);

    if (fileInput) fileInput.disabled = false;
    if (img) img.src = '';
  }

  function enableFormEditing() {
    document.getElementById("DeliveryStaff").disabled = false;
    document.getElementById("Comments").disabled = false;
    document.getElementById("media").disabled = false;
    document.getElementById("media2").disabled = false;
    document.getElementById("media3").disabled = false;

    const submitButton = document.querySelector("button[type='submit']");
    submitButton.disabled = false;
    submitButton.innerText = "Submit";
  }

  // Event listener for "Change" button
  document.getElementById("changeButton").addEventListener("click", enableFormEditing);

  // Event listeners for picture delete buttons
  ["Pic1Delete", "Pic2Delete", "Pic3Delete"].forEach(function (btnId) {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.addEventListener("click", function () {
        // Optionally hide the image or clear a field here
        enableFormEditing();
      });
    }
  });

function enableFormEditing() {
  document.getElementById("DeliveryStaff").disabled = false;
  document.getElementById("Comments").disabled = false;
  document.getElementById("media").disabled = false;
  document.getElementById("media2").disabled = false;
  document.getElementById("media3").disabled = false;

  const submitButton = document.querySelector("button[type='submit']");
  submitButton.disabled = false;
  submitButton.innerText = "Submit";
}

// Connect delete buttons to enable editing
["Pic1Delete", "Pic2Delete", "Pic3Delete"].forEach(function (btnId) {
  const btn = document.getElementById(btnId);
  if (btn) {
    btn.addEventListener("click", function () {
      enableFormEditing();
    });
  }
});


</script>

  </body>
</html>
